<!DOCTYPE html>
<html lang="ja">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8536456976562388"
     crossorigin="anonymous"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>タイマー</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f0f0f0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      position: relative;
    }

    .timer-display {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40vmin; /* 初期表示から大きく */
      font-weight: bold;
      transition: font-size 0.3s;
      text-align: center;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
      transition: opacity 0.3s, transform 0.3s;
    }

    .controls.hidden {
      opacity: 0;
      transform: translateY(100%);
    }

    button {
      padding: 15px;
      font-size: 4vmin;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .set-btn { background: #ffc107; color: #212529; }
    .start-btn { background: #28a745; }
    .stop-btn { background: #dc3545; }
    .reset-btn { background: #6c757d; }

    .settings-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      display: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
      width: 80%;
      max-width: 400px;
    }

    .settings-panel.open {
      display: block;
      opacity: 1;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 999;
    }

    .overlay.show {
      display: block;
    }

    .control-group {
      margin: 15px 0;
    }

    input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }

    .value-display {
      float: right;
      font-weight: bold;
    }

    /* 横向き表示用のスタイル */
    .landscape-mode {
      transform: rotate(90deg);
      transform-origin: center center;
      width: 100vh;
      height: 100vw;
      position: fixed;
      top: 0;
      left: 0;
    }

    /* スマホ用の調整 */
    @media (max-width: 768px) {
      .timer-display {
        font-size: 20vmin; /* スマホでの初期サイズを小さめに */
      }
      
      .timer-display.expanded {
        font-size: 28vmin; /* 横向き最大表示時 */
      }
    }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="timer-display" id="timerDisplay">00:00:00</div>
    <div class="controls" id="controls">
      <button class="set-btn" id="setBtn">設定</button>
      <button class="start-btn" id="startBtn">開始</button>
      <button class="stop-btn" id="stopBtn" disabled>停止</button>
      <button class="reset-btn" id="resetBtn">リセット</button>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="settings-panel" id="settingsPanel">
      <div class="control-group">
        <label>時間: <span id="hoursVal" class="value-display">0</span></label>
        <input type="range" id="hours" min="0" max="23" value="0">
      </div>
      <div class="control-group">
        <label>分: <span id="minutesVal" class="value-display">0</span></label>
        <input type="range" id="minutes" min="0" max="59" value="0">
      </div>
      <div class="control-group">
        <label>秒: <span id="secondsVal" class="value-display">0</span></label>
        <input type="range" id="seconds" min="0" max="59" value="0">
      </div>
      <div class="control-group">
        <label>音量: <span id="volumeVal" class="value-display">0.5</span></label>
        <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
      </div>
      <div class="control-group">
        <label>繰り返し回数: <input type="number" id="repeatCount" min="0" value="0"></label>
        <label><input type="checkbox" id="infiniteRepeat"> 常に繰り返し</label>
      </div>
    </div>
  </div>

  <audio id="alarmAudio">
    <source src="https://www.soundjay.com/buttons/sounds/beep-01a.mp3" type="audio/mp3">
  </audio>

  <script>
    const timerDisplay = document.getElementById('timerDisplay');
    const container = document.getElementById('container');
    const controls = document.getElementById('controls');
    const settingsPanel = document.getElementById('settingsPanel');
    const overlay = document.getElementById('overlay');
    const setBtn = document.getElementById('setBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const alarmAudio = document.getElementById('alarmAudio');

    let isRunning = false;
    let isSettingsOpen = false;
    let totalTime = 0;
    let remainingTime = 0;
    let timerInterval;
    let inactivityTimer;
    let isLandscape = false;
    const INACTIVITY_TIMEOUT = 3000; // 3秒後にコントロールを非表示

    // モバイルデバイス判定
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // 初期表示
    controls.classList.add('hidden'); // 初期表示ではコントロールを非表示
    
    // 設定パネルの開閉
    setBtn.addEventListener('click', () => {
      isSettingsOpen = !isSettingsOpen;
      settingsPanel.classList.toggle('open', isSettingsOpen);
      overlay.classList.toggle('show', isSettingsOpen);
      updateButtonStates();
      if (isSettingsOpen) {
        showControls();
        // 設定画面表示時は横向きモードを解除
        if (isLandscape) {
          toggleLandscape(false);
        }
      }
    });

    // オーバーレイクリックで閉じる
    overlay.addEventListener('click', () => {
      isSettingsOpen = false;
      settingsPanel.classList.remove('open');
      overlay.classList.remove('show');
      updateButtonStates();
    });

    // タイマー開始
    startBtn.addEventListener('click', () => {
      if (isRunning || isSettingsOpen) return;
      const hours = parseInt(document.getElementById('hours').value);
      const minutes = parseInt(document.getElementById('minutes').value);
      const seconds = parseInt(document.getElementById('seconds').value);
      totalTime = remainingTime = (hours * 3600 + minutes * 60 + seconds) * 1000;

      if (totalTime <= 0) return;

      isRunning = true;
      timerInterval = setInterval(updateTimer, 1000);
      showControls();
      updateButtonStates();
      updateDisplay();
      
      // タイマー開始後、短時間でコントロールを非表示に
      setTimeout(hideControls, INACTIVITY_TIMEOUT);
    });

    // タイマー停止
    stopBtn.addEventListener('click', () => {
      clearInterval(timerInterval);
      isRunning = false;
      updateButtonStates();
      
      // 停止時に横向きモードを解除
      if (isLandscape) {
        toggleLandscape(false);
      }
    });

    // タイマーリセット
    resetBtn.addEventListener('click', () => {
      clearInterval(timerInterval);
      isRunning = false;
      remainingTime = totalTime;
      updateDisplay();
      updateButtonStates();
      showControls();
      
      // リセット時に横向きモードを解除
      if (isLandscape) {
        toggleLandscape(false);
      }
    });

    // タイマー更新
    function updateTimer() {
      remainingTime -= 1000;
      if (remainingTime <= 0) {
        clearInterval(timerInterval);
        alarmAudio.play();
        handleRepeat();
        return;
      }
      updateDisplay();
    }

    // 繰り返し処理
    function handleRepeat() {
      const repeatCount = parseInt(document.getElementById('repeatCount').value);
      const infiniteRepeat = document.getElementById('infiniteRepeat').checked;

      if (infiniteRepeat || repeatCount > 0) {
        if (!infiniteRepeat) document.getElementById('repeatCount').value = repeatCount - 1;
        remainingTime = totalTime;
        isRunning = true;
        timerInterval = setInterval(updateTimer, 1000);
        updateDisplay();
      } else {
        isRunning = false;
        updateButtonStates();
        showControls(); // タイマー終了後にコントロールを表示
        // タイマー終了時に横向きモードを解除
        if (isLandscape) {
          toggleLandscape(false);
        }
      }
    }

    // 表示更新
    function updateDisplay() {
      const totalSeconds = Math.floor(remainingTime / 1000);
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const seconds = String(totalSeconds % 60).padStart(2, '0');
      timerDisplay.textContent = `${hours}:${minutes}:${seconds}`;
      
      // フォントサイズを動的に調整（特に横向きモード時）
      if (isLandscape && isMobile) {
        timerDisplay.style.fontSize = window.innerHeight * 0.4 + 'px';
      }
    }

    // ボタンの状態更新
    function updateButtonStates() {
      startBtn.disabled = isRunning || isSettingsOpen;
      stopBtn.disabled = !isRunning || isSettingsOpen;
      resetBtn.disabled = isSettingsOpen;
    }

    // コントロールの表示
    function showControls() {
      clearTimeout(inactivityTimer);
      controls.classList.remove('hidden');
      timerDisplay.classList.remove('expanded');
      
      if (isLandscape) {
        toggleLandscape(false);
      }
      
      if (isRunning && !isSettingsOpen) {
        inactivityTimer = setTimeout(hideControls, INACTIVITY_TIMEOUT);
      }
    }

    // コントロールの非表示
    function hideControls() {
      if (isSettingsOpen) return;
      
      controls.classList.add('hidden');
      timerDisplay.classList.add('expanded');
      
      // スマホの場合は横向きモードに
      if (isMobile && isRunning) {
        toggleLandscape(true);
      }
    }

    // 横向きモード切替
    function toggleLandscape(enable) {
      if (enable && !isLandscape) {
        isLandscape = true;
        container.classList.add('landscape-mode');
        document.body.style.backgroundColor = '#000';
        timerDisplay.style.color = '#fff';
        
        // 横向きモード時のフォントサイズ最適化
        if (window.innerWidth < window.innerHeight) {
          // 縦長の場合は横向きにすると高さが制限要因
          timerDisplay.style.fontSize = window.innerHeight * 0.4 + 'px';
        } else {
          // 横長の場合は幅が制限要因
          timerDisplay.style.fontSize = window.innerWidth * 0.2 + 'px';
        }
        
        // 横向き表示をリクエスト（iOS/Androidのみ対応）
        if ('orientation' in screen) {
          try {
            screen.orientation.lock('landscape').catch(() => {
              // エラーは無視（ユーザーの手動操作に委ねる）
            });
          } catch (e) {
            // 古いデバイスやサポートされていないブラウザ向け
          }
        }
      } else if (!enable && isLandscape) {
        isLandscape = false;
        container.classList.remove('landscape-mode');
        document.body.style.backgroundColor = '#f0f0f0';
        timerDisplay.style.color = '';
        timerDisplay.style.fontSize = '';
        
        // 横向きロックを解除
        if ('orientation' in screen) {
          try {
            screen.orientation.unlock();
          } catch (e) {
            // エラーは無視
          }
        }
      }
    }

    // ユーザー操作の検知
    ['mousemove', 'touchstart', 'click'].forEach(event => {
      document.addEventListener(event, () => {
        if (controls.classList.contains('hidden')) {
          showControls();
        } else {
          // 操作があった場合タイマーをリセット
          if (isRunning && !isSettingsOpen) {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(hideControls, INACTIVITY_TIMEOUT);
          }
        }
      });
    });

    // 画面サイズ変更時の処理
    window.addEventListener('resize', () => {
      // 横向きモード時のフォントサイズ調整
      if (isLandscape) {
        if (window.innerWidth < window.innerHeight) {
          timerDisplay.style.fontSize = window.innerHeight * 0.4 + 'px';
        } else {
          timerDisplay.style.fontSize = window.innerWidth * 0.2 + 'px';
        }
      }
    });

    // 音量テスト再生用のデバウンス関数
    let volumeTestTimeout;
    function testVolume() {
      clearTimeout(volumeTestTimeout);
      volumeTestTimeout = setTimeout(() => {
        alarmAudio.currentTime = 0; // 音声の再生位置を最初に戻す
        alarmAudio.play();
        setTimeout(() => {
          alarmAudio.pause(); // 短時間だけ再生して停止
          alarmAudio.currentTime = 0;
        }, 200); // 200msだけ再生
      }, 100); // 100msのデバウンス
    }

    // 設定値の表示更新
    document.querySelectorAll('input[type="range"]').forEach(input => {
      input.addEventListener('input', () => {
        document.getElementById(`${input.id}Val`).textContent = input.value;
        if (input.id === 'volume') {
          alarmAudio.volume = input.value;
          testVolume(); // 音量変更時にテスト再生
        }
      });
    });

    // 初期表示更新
    document.getElementById('hoursVal').textContent = document.getElementById('hours').value;
    document.getElementById('minutesVal').textContent = document.getElementById('minutes').value;
    document.getElementById('secondsVal').textContent = document.getElementById('seconds').value;
    document.getElementById('volumeVal').textContent = document.getElementById('volume').value;
    alarmAudio.volume = document.getElementById('volume').value;
    
    // 初期表示時にコントロールを非表示
    hideControls();
  </script>
</body>
</html>